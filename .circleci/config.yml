version: 2.1

executors:
  node:
    docker:
      - image: circleci/node:14 # Use a general Node.js 14 image

jobs:
  build:
    executor: node
    steps:
      - checkout
      - run:
          name: Install nvm
          command: curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash
      - run:
          name: Install Node.js 14.21.0
          command: |
            source ~/.nvm/nvm.sh
            nvm install 14.21.0
            nvm use 14.21.0
            nvm alias default 14.21.0
      - run:
          name: Install Yarn
          command: npm install -g yarn

      - run:
          name: Install Dependencies
          command: yarn install

      - run:
          name: Build Project
          command: yarn build --if-present

      - run:
          name: Run Tests
          command: yarn test --if-present

  deploy:
    executor: node
    needs: build
    steps:
      - checkout
      - run:
          name: Install nvm
          command: curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash
      - run:
          name: Install Node.js 14.21.0
          command: |
            source ~/.nvm/nvm.sh
            nvm install 14.21.0
            nvm use 14.21.0
            nvm alias default 14.21.0
      - run:
          name: Install Yarn
          command: npm install -g yarn

      - run:
          name: Install Dependencies
          command: yarn install

      - run:
          name: Build Project
          command: yarn build --if-present

      - run:
          name: Deploy to Render
          command: |
            curl -X POST \
            -H "Accept: application/json" \
            -H "Authorization: Bearer ${RENDER_API_KEY}" \
            -H "Content-Type: application/json" \
            --data '{"serviceId": "${RENDER_SERVICE_ID}", "branch": "main"}' \
            https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys

workflows:
  version: 2
  build_and_deploy:
    jobs:
      - build
      - deploy:
          requires:
            - build
